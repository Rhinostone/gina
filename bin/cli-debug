#!/usr/bin/env node
'use strict';
/**
 * Mainly used to debug framework CMD lib - default port should be #5858 by default
 * To modify the debug port :
 * 
 * $ gina framework:set --debug-port=<your new debug port>
 */
const fs    = require('fs');
const {exec} = require('child_process');
const os    = require('os');

var isWin32 = function() {
    return (os.platform() == 'win32') ? true : false;
}

var argv = process.argv.splice(2);
argv = argv.join(' ');

console.log('running: gina ' + argv );

// fetching config
var homeDir = (process.env[(isWin32()) ? 'USERPROFILE' : 'HOME'] );
homeDir += (isWin32()) ? '\\.gina' :  '/.gina';
var mainConf = require(homeDir + ((isWin32()) ? '\\main.json' : '/main.json'));

var version = mainConf.def_framework.split(/\./g);
version = version.splice(0, 2).join('.');

var settings = require(homeDir + ((isWin32()) ? '\\' + version + '\\settings.json' : '/' + version +'/settings.json'));

var debugPort = null;
var params = argv.split(/\s+/g);
if ( params.length > 0 ) {
    for (var p = 0, len = params.length; p < len; ++p) {
        if ( /^\-\-debug(\_|\-)port/.test(params[p]) ) {
            setEnvVar('GINA_DEBUG_PORT', params[p].split(/\=/)[1]);
            continue;
        }
        if ( /^\-\-(inspect|debug)/.test(params[p]) ) {
            debugPort = params[p];
            process.argv.splice(p,1);   
        }
    }
}

// gina defaullt debug port
debugPort = (debugPort != null) ? debugPort : '--inspect-brk=' + settings.debug_port;
console.log('You should now start debug on port #'+ settings.debug_port);
exec('node ' + debugPort +' '+ __dirname +'/cli ' + argv, (error, stdout, stderr) => {
    if (error) {
        console.error(`exec error: ${error}`);
        return;
    }
    console.log(`${stdout}`);
});